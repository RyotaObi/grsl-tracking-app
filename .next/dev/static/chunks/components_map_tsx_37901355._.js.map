{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/admin/Documents/my-app/components/map.tsx"],"sourcesContent":["\"use client\"\r\n\r\nimport { useEffect, useRef } from \"react\"\r\nimport type { LocationData } from \"@/lib/types\"\r\n\r\ninterface MapProps {\r\n  locations: LocationData[]\r\n  plannedRoute?: [number, number][]\r\n  onMapReady?: (map: any) => void\r\n  userLocation?: { lat: number; lng: number } | null\r\n}\r\n\r\nexport default function Map({ locations, plannedRoute, onMapReady, userLocation }: MapProps) {\r\n  const mapRef = useRef<any | null>(null)\r\n  const containerRef = useRef<HTMLDivElement>(null)\r\n  const vehicleMarkerRef = useRef<any | null>(null)\r\n  const routeLayerRef = useRef<any | null>(null)\r\n  const traveledRouteRef = useRef<any | null>(null)\r\n  const leafletRef = useRef<any>(null)\r\n  const userMarkerRef = useRef<any | null>(null)\r\n\r\n  useEffect(() => {\r\n    const loadLeaflet = async () => {\r\n      if (leafletRef.current) return\r\n\r\n      const L = await import(\"leaflet\")\r\n\r\n      delete (L.default.Icon.Default.prototype as any)._getIconUrl\r\n      L.default.Icon.Default.mergeOptions({\r\n        iconRetinaUrl: \"https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon-2x.png\",\r\n        iconUrl: \"https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png\",\r\n        shadowUrl: \"https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png\",\r\n      })\r\n\r\n      leafletRef.current = L.default\r\n    }\r\n\r\n    loadLeaflet()\r\n  }, [])\r\n\r\n  useEffect(() => {\r\n    if (!containerRef.current || mapRef.current || !leafletRef.current) {\r\n      return\r\n    }\r\n\r\n    const L = leafletRef.current\r\n\r\n    const map = L.map(containerRef.current, {\r\n      zoomControl: false,\r\n      dragging: true,\r\n      touchZoom: true,\r\n      scrollWheelZoom: true,\r\n      doubleClickZoom: true,\r\n      boxZoom: true,\r\n      tap: true,\r\n    }).setView([35.6393079, 140.0465158], 15)\r\n\r\n    L.tileLayer(\"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png\", {\r\n      attribution: \"© OpenStreetMap contributors\",\r\n      maxZoom: 19,\r\n    }).addTo(map)\r\n\r\n    mapRef.current = map\r\n\r\n    if (onMapReady) {\r\n      onMapReady(map)\r\n    }\r\n\r\n    const timeoutId = setTimeout(() => {\r\n      if (mapRef.current && mapRef.current.invalidateSize) {\r\n        mapRef.current.invalidateSize()\r\n      }\r\n    }, 100)\r\n\r\n    return () => {\r\n      clearTimeout(timeoutId)\r\n      if (mapRef.current) {\r\n        mapRef.current.remove()\r\n        mapRef.current = null\r\n      }\r\n    }\r\n  }, [onMapReady, leafletRef.current])\r\n\r\n  useEffect(() => {\r\n    if (!mapRef.current || !plannedRoute || plannedRoute.length === 0 || !leafletRef.current) return\r\n\r\n    if (routeLayerRef.current) {\r\n      routeLayerRef.current.remove()\r\n    }\r\n\r\n    const updateRouteStyle = () => {\r\n      if (!mapRef.current || !routeLayerRef.current) return\r\n      const zoom = mapRef.current.getZoom()\r\n      const weight = Math.max(4, Math.min(14, 4 + (zoom - 15) * 2))\r\n      routeLayerRef.current.setStyle({ weight })\r\n    }\r\n\r\n    const routeLayer = leafletRef.current\r\n      .polyline(plannedRoute, {\r\n        color: \"#2B7FFF\",\r\n        weight: 4,\r\n        opacity: 0.8,\r\n      })\r\n      .addTo(mapRef.current)\r\n\r\n    routeLayerRef.current = routeLayer\r\n\r\n    mapRef.current.on(\"zoomend\", updateRouteStyle)\r\n    updateRouteStyle()\r\n\r\n    return () => {\r\n      if (mapRef.current) {\r\n        mapRef.current.off(\"zoomend\", updateRouteStyle)\r\n      }\r\n    }\r\n  }, [plannedRoute])\r\n\r\n  useEffect(() => {\r\n    if (!mapRef.current || locations.length === 0 || !leafletRef.current) return\r\n\r\n    const latestLocation = locations[locations.length - 1]\r\n\r\n    // 進行方向を計算（最新の位置とその前の位置から角度を計算）\r\n    let bearing = 0\r\n    if (locations.length > 1) {\r\n      const prevLocation = locations[locations.length - 2]\r\n      const lat1 = (prevLocation.latitude * Math.PI) / 180\r\n      const lat2 = (latestLocation.latitude * Math.PI) / 180\r\n      const dLon = ((latestLocation.longitude - prevLocation.longitude) * Math.PI) / 180\r\n\r\n      const y = Math.sin(dLon) * Math.cos(lat2)\r\n      const x = Math.cos(lat1) * Math.sin(lat2) - Math.sin(lat1) * Math.cos(lat2) * Math.cos(dLon)\r\n\r\n      bearing = (Math.atan2(y, x) * 180) / Math.PI\r\n      bearing = (bearing + 360) % 360 // 0-360度に正規化\r\n    }\r\n\r\n    // 矢印型のアイコンを作成（SVGを使用）\r\n    const vehicleIcon = leafletRef.current.divIcon({\r\n      className: \"vehicle-marker\",\r\n      html: `\r\n        <svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" style=\"transform: rotate(${bearing}deg); transform-origin: center center;\">\r\n          <defs>\r\n            <filter id=\"shadow\" x=\"-50%\" y=\"-50%\" width=\"200%\" height=\"200%\">\r\n              <feDropShadow dx=\"0\" dy=\"2\" stdDeviation=\"2\" flood-opacity=\"0.3\"/>\r\n            </filter>\r\n          </defs>\r\n          <path\r\n            d=\"M 12 2 L 20 18 L 12 14 L 4 18 Z\"\r\n            fill=\"#00C950\"\r\n            stroke=\"white\"\r\n            stroke-width=\"2\"\r\n            filter=\"url(#shadow)\"\r\n          />\r\n          <circle cx=\"12\" cy=\"12\" r=\"4\" fill=\"white\" stroke=\"#00C950\" stroke-width=\"1.5\"/>\r\n        </svg>\r\n      `,\r\n      iconSize: [24, 24],\r\n      iconAnchor: [12, 12], // 中心を位置に合わせる\r\n    })\r\n\r\n    if (vehicleMarkerRef.current) {\r\n      vehicleMarkerRef.current.setLatLng([latestLocation.latitude, latestLocation.longitude])\r\n      // アイコンを更新（角度が変わった場合）\r\n      vehicleMarkerRef.current.setIcon(vehicleIcon)\r\n    } else {\r\n      vehicleMarkerRef.current = leafletRef.current\r\n        .marker([latestLocation.latitude, latestLocation.longitude], {\r\n          icon: vehicleIcon,\r\n        })\r\n        .addTo(mapRef.current)\r\n    }\r\n\r\n    if (locations.length > 1) {\r\n      const traveledPath = locations.map((loc) => [loc.latitude, loc.longitude]) as [number, number][]\r\n\r\n      if (traveledRouteRef.current) {\r\n        traveledRouteRef.current.setLatLngs(traveledPath)\r\n      } else {\r\n        traveledRouteRef.current = leafletRef.current\r\n          .polyline(traveledPath, {\r\n            color: \"#51A2FF\",\r\n            weight: 3,\r\n            opacity: 0.6,\r\n            dashArray: \"10, 10\",\r\n          })\r\n          .addTo(mapRef.current)\r\n      }\r\n    }\r\n  }, [locations])\r\n\r\n  useEffect(() => {\r\n    if (!mapRef.current || !userLocation || !leafletRef.current) {\r\n      return\r\n    }\r\n\r\n    if (userMarkerRef.current) {\r\n      userMarkerRef.current.setLatLng([userLocation.lat, userLocation.lng])\r\n    } else {\r\n      const userIcon = leafletRef.current.divIcon({\r\n        className: \"user-marker\",\r\n        html: `\r\n          <div style=\"\r\n            width: 18px;\r\n            height: 18px;\r\n            background: #2B7FFF;\r\n            border: 3px solid white;\r\n            border-radius: 50%;\r\n            box-shadow: 0 2px 8px rgba(0,0,0,0.3);\r\n          \"></div>\r\n        `,\r\n        iconSize: [18, 18],\r\n        iconAnchor: [9, 9],\r\n      })\r\n\r\n      userMarkerRef.current = leafletRef.current\r\n        .marker([userLocation.lat, userLocation.lng], {\r\n          icon: userIcon,\r\n        })\r\n        .addTo(mapRef.current)\r\n    }\r\n  }, [userLocation])\r\n\r\n  return (\r\n    <div\r\n      ref={containerRef}\r\n      style={{\r\n        width: \"100%\",\r\n        height: \"100%\",\r\n        position: \"absolute\",\r\n        top: 0,\r\n        left: 0,\r\n        zIndex: 1,\r\n        isolation: \"isolate\",\r\n      }}\r\n    />\r\n  )\r\n}\r\n"],"names":[],"mappings":"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","debugId":null}}]
}